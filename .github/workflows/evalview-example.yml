# =============================================================================
# EXAMPLE WORKFLOW - Copy this to your own repository!
# =============================================================================
# This file demonstrates how to use the EvalView GitHub Action.
# It is NOT meant to run in the EvalView repo itself.
#
# To use in your project:
# 1. Copy this file to your repo at .github/workflows/evalview.yml
# 2. Add OPENAI_API_KEY to your repository secrets
# 3. Create test cases in .evalview/test-cases/
# =============================================================================

name: "[Example] EvalView Agent Tests"

# This workflow only runs manually - it's a template for users to copy
on:
  workflow_dispatch:
    inputs:
      filter:
        description: 'Filter tests by name pattern'
        required: false

jobs:
  test-agents:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run EvalView
        id: evalview
        uses: hidai25/eval-view@v0.1.3
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          filter: ${{ github.event.inputs.filter }}
          max-workers: '4'
          fail-on-error: 'true'
          generate-report: 'true'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evalview-results
          path: |
            .evalview/results/*.json
            evalview-report.html
          if-no-files-found: ignore
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const total = '${{ steps.evalview.outputs.total-tests }}';
            const passed = '${{ steps.evalview.outputs.passed-tests }}';
            const failed = '${{ steps.evalview.outputs.failed-tests }}';
            const passRate = '${{ steps.evalview.outputs.pass-rate }}';

            const status = failed > 0 ? ':x:' : ':white_check_mark:';

            const body = `## ${status} EvalView Test Results

            | Metric | Value |
            |--------|-------|
            | Total Tests | ${total} |
            | Passed | ${passed} |
            | Failed | ${failed} |
            | Pass Rate | ${passRate}% |

            [View full report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
